<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∏—Å–µ–ª | Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        margin: 0;
        padding: 0 0 16px 0;
        color-scheme: var(--tg-color-scheme);
      }
      .container {
        max-width: 480px;
        margin: auto;
        padding: 18px 10px 0 10px;
      }
      .header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 22px;
        background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        border-radius: 14px;
        padding: 12px;
      }
      .avatar,
      .avatar-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        background: #eee;
        font-size: 22px;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .avatar-placeholder {
        background: linear-gradient(135deg, #3390ec 0%, #40a7e3 100%);
      }
      .user-info .user-name {
        font-weight: 700;
        font-size: 18px;
      }
      .user-info .user-stats {
        font-size: 14px;
        opacity: 0.7;
      }
      .main-card {
        background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        border-radius: 16px;
        padding: 22px;
        margin-bottom: 18px;
      }
      .number-display {
        font-size: 56px;
        font-weight: bold;
        color: var(--tg-theme-link-color, #3390ec);
        margin: 10px 0;
      }
      .generate-btn {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 11px;
        border: none;
        background: var(--tg-theme-button-color, #3390ec);
        color: var(--tg-theme-button-text-color, #fff);
        margin-top: 10px;
        cursor: pointer;
      }
      .generate-btn:active {
        transform: scale(0.97);
      }
      .history-section {
        margin-top: 16px;
      }
      .history-title {
        font-size: 17px;
        margin-bottom: 6px;
      }
      .history-list {
        background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        border-radius: 11px;
        padding: 12px;
        max-height: 180px;
        overflow-y: auto;
      }
      .history-item {
        border-bottom: 1px solid #e0e0e0;
        padding: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .history-item:last-child {
        border-bottom: none;
      }
      .empty-state {
        text-align: center;
        opacity: 0.55;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <img id="userAvatar" class="avatar" src="" style="display: none" />
        <div
          id="avatarPlaceholder"
          class="avatar-placeholder"
          style="display: none"
        ></div>
        <div class="user-info">
          <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          <div class="user-stats" id="userStats">–ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
        </div>
      </div>

      <div class="main-card">
        <h2>üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∏—Å–µ–ª</h2>
        <div class="number-display" id="numberDisplay">?</div>
        <button class="generate-btn" id="generateBtn">
          –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ
        </button>
      </div>

      <div class="history-section">
        <div class="history-title">üìà –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
        <div class="history-list" id="historyList">
          <div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∏—Å–µ–ª</div>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://vnpwsfzyzrpojzehvmae.supabase.co"; // —Ç–≤–æ–π Supabase URL
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZucHdzZnp5enJwb2p6ZWh2bWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDIzMTMsImV4cCI6MjA3Njk3ODMxM30.jyvB4SlNPimetrWCqYg6x5lO09dTIT9TOtTSKMX6VgA";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const user = tg.initDataUnsafe?.user;
      let userHistory = [];

      function showAvatar() {
        const avatar = document.getElementById("userAvatar");
        const placeholder = document.getElementById("avatarPlaceholder");
        if (user && user.photo_url) {
          avatar.src = user.photo_url;
          avatar.style.display = "block";
          placeholder.style.display = "none";
        } else if (user) {
          placeholder.textContent = (user.first_name ||
            user.username ||
            "U")[0].toUpperCase();
          placeholder.style.display = "flex";
          avatar.style.display = "none";
        } else {
          placeholder.textContent = "U";
          placeholder.style.display = "flex";
        }
      }

      async function loadUserData() {
        if (!user) return;
        const statsEl = document.getElementById("userStats");
        const listEl = document.getElementById("historyList");
        statsEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...";
        listEl.innerHTML = '<div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        let { data, error } = await supabase
          .from("numbers")
          .select("*")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false });
        if (error) {
          statsEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
          listEl.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
          return;
        }
        userHistory = data || [];
        statsEl.textContent =
          "–í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: " + (userHistory.length || 0);
        renderHistory();
      }

      function renderHistory() {
        const listEl = document.getElementById("historyList");
        if (!userHistory.length) {
          listEl.innerHTML =
            '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∏—Å–µ–ª</div>';
          return;
        }
        listEl.innerHTML = userHistory
          .map((item) => {
            const date = new Date(item.created_at);
            const timeStr = date.toLocaleString("ru-RU", {
              day: "2-digit",
              month: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });
            return `<div class="history-item">
            <span><b>${item.number}</b></span>
            <span style="font-size:12px;opacity:0.67">${timeStr}</span>
        </div>`;
          })
          .join("");
      }

      async function saveNumber(number) {
        if (!user) return;
        let { error } = await supabase.from("numbers").insert([
          {
            user_id: user.id,
            username: user.username || null,
            first_name: user.first_name || "",
            number: number,
          },
        ]);
        if (error) throw error;
      }

      document.getElementById("userName").textContent =
        user?.first_name || user?.username || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      showAvatar();
      loadUserData();

      // –ó–∞–º–µ–Ω—è–π –≤–µ—Å—å —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≠–¢–û:
      document.getElementById("generateBtn").onclick = async () => {
        const btn = document.getElementById("generateBtn");
        btn.disabled = true;
        const rand = Math.floor(Math.random() * 100) + 1;
        document.getElementById("numberDisplay").textContent = rand;

        try {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
          await saveNumber(rand);

          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —à–ª–µ–º HTTP –∫ —Ç–≤–æ–µ–º—É Python-–±–æ—Ç—É
          await fetch("http://178.20.211.213:5000/notify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: user.id,
              number: rand,
            }),
          });

          tg.showAlert("üéâ –í–∞—à–µ —á–∏—Å–ª–æ: " + rand + "!");
          await loadUserData();
        } catch (e) {
          console.error(e);
          tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        }
        btn.disabled = false;
      };
    </script>
  </body>
</html>
